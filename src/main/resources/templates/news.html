<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{'./templates/common/layout.html' :: layout(~{::title}, ~{::section})}" lang="en">
<head>
  <title th:text="|9rove - ${pageTitle}|"></title>
</head>
<body>
<section>
  <script>
    /*<![CDATA[*/
    const epochMillis = [[${epochMillis}]];
    /*]]>*/
    /*<![CDATA[*/
    const lastNewsEpochMilli = [[${lastNewsEpochMilli}]];
    /*]]>*/

    function formatElapsedTime(ms) {
      const seconds = Math.floor(ms / 1000);
      if (seconds < 60) return `${seconds} second${seconds !== 1 ? 's' : ''} ago`;

      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;

      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours} hour${hours !== 1 ? 's' : ''} ago`;

      const days = Math.floor(hours / 24);
      if (days < 30) return `${days} day${days !== 1 ? 's' : ''} ago`;

      const months = Math.floor(days / 30); // Rough estimate
      return `${months} month${months !== 1 ? 's' : ''} ago`;
    }

    document.addEventListener("DOMContentLoaded", () => {
        const lastUpdated = new Date(epochMillis);
        const lastMessage = new Date(lastNewsEpochMilli);
        console.log(lastNewsEpochMilli);

        function update() {
          const now = new Date().getTime();
          const delta = Math.floor((now - lastUpdated) / 1000);
          const updated = document.getElementById("updated");
          if (updated && updated.dataset.original === undefined) {
            updated.dataset.original = updated.textContent;
          }
          if (updated) {
            const lastMessageDelta = formatElapsedTime(now - lastMessage);
            updated.textContent = `${updated.dataset.original} Last synced ${delta} seconds ago. Syncs every minute. Last message was ${lastMessageDelta}.`;
          }
        }

        update();
        setInterval(update, 1000);
      }
    );
  </script>
  <header>
    <h1 data-th-text="${tableHeader}"></h1>
    <p id="updated" style="color: grey"></p>
    <p data-th-text="${tableSubheader}" class="secondary"></p>
  </header>
  <section class="section-highlight">
    <h2>
      <i data-th-text="${lucideIcon}" data-lucide="${lucideIcon}"></i>
      <span th:fragment="newsIcon(category)">
        <i data-lucide="newspaper" th:if="${category == 'general'}"></i>
        <i data-lucide="dollar-sign" th:if="${category == 'forex'}"></i>
        <i data-lucide="shield-check" th:if="${category == 'crypto'}"></i>
      <i data-lucide="handshake" th:if="${category == 'merger'}"></i>
      </span>
      All news
    </h2>
    <table role="grid">
      <thead>
      <tr>
        <th>Date</th>
        <th>Headline</th>
        <th>Summary</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="element : ${elements}">
        <td th:text="${element.datetime}" class="nobr align-top"/>
        <td class="align-top">
          <a th:href="@{{url}(url=${element.url})}" th:text="${element.headline}" th:target="_blank"></a>
        </td>
        <td th:utext="${element.summary}"></td>
      </tr>
      </tbody>
    </table>
  </section>
  <script src="/static/beautify-table.js?v=1.0.31"></script>
  <script>lucide.createIcons();</script>
</section>
</body>
</html>
